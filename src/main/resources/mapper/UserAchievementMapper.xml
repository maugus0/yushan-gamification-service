<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yushan.gamification_service.dao.UserAchievementMapper">

    <insert id="insert" parameterType="com.yushan.gamification_service.entity.UserAchievement" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_achievements (user_id, achievement_id, unlocked_at)
        VALUES (#{userId}, #{achievementId}, NOW())
    </insert>

    <select id="findByUserId" resultType="com.yushan.gamification_service.entity.UserAchievement">
        SELECT
            id,
            user_id AS userId,
            achievement_id AS achievementId,
            unlocked_at AS unlockedAt
        FROM
            user_achievements
        WHERE
            user_id = #{userId}
    </select>

    <select id="findByUserIdAndAchievementId" resultType="java.lang.Long">
        SELECT
            id
        FROM
            user_achievements
        WHERE
            user_id = #{userId} AND achievement_id = #{achievementId}
        LIMIT 1
    </select>

    <resultMap id="AchievementDTOMap" type="com.yushan.gamification_service.dto.achievement.AchievementDTO">
        <result property="id" column="achievement_id"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="iconUrl" column="icon_url"/>
        <result property="unlockedAt" column="unlocked_at"/>
    </resultMap>

    <select id="findUnlockedAchievementsByUserId" resultMap="AchievementDTOMap">
        SELECT
            ua.unlocked_at,
            a.id AS achievement_id,
            a.name,
            a.description,
            a.icon_url
        FROM
            user_achievements ua
                JOIN
            achievements a ON ua.achievement_id = a.id
        WHERE
            ua.user_id = #{userId}
        ORDER BY
            ua.unlocked_at DESC
    </select>

</mapper>